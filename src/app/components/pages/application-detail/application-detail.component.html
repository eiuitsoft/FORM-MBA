<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="mb-8 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">
        {{ isEditMode() ? ('APPLICATION_PAGE.TITLE_EDIT' | translate) : ('APPLICATION_PAGE.TITLE_DETAILS' | translate)
        }}
      </h1>
    </div>
    <div class="flex gap-3">
      @if (!isEditMode()) {
      <button (click)="exportToPDF()" [disabled]="exporting()"
        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2">
        @if (!exporting()) {
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        } @else {
        <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        }
        {{ exporting() ? ('APPLICATION_PAGE.EXPORTING' | translate) : ('APPLICATION_PAGE.EXPORT_PDF' | translate) }}
      </button>
      <button (click)="toggleEditMode()"
        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#a68557] hover:bg-[#8b6d47]">
        {{ 'APPLICATION_PAGE.EDIT_APPLICATION' | translate }}
      </button>
      }
      @if (isEditMode()) {
      <button (click)="cancelEdit()"
        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
      <button (click)="saveChanges()" [disabled]="saving()"
        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400">
        {{ saving() ? ('APPLICATION_PAGE.SAVING' | translate) : ('APPLICATION_PAGE.SAVE_CHANGES' | translate) }}
      </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
  <div class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#a68557]"></div>
    <p class="mt-4 text-gray-600">{{ 'APPLICATION_PAGE.LOADING' | translate }}</p>
  </div>
  }

  <!-- View Mode -->
  @if (!loading() && !isEditMode() && applicationData()) {
  <!-- Personal Details -->
  <app-personal-details-view class="block mb-8" [data]="applicationData()?.personalDetails"
    [uploadedFiles]="uploadedFiles()" (onFilesUpdate)="onViewFilesUpdate($event)" />

  <!-- Application Details -->
  <app-application-details-view class="block mb-8" [data]="applicationData()?.applicationDetails" />

  <!-- Education Details -->
  <app-education-details-view class="block mb-8" [data]="applicationData()?.educationDetails"
    [undergraduateFiles]="undergraduateFiles()" [postgraduateFiles]="postgraduateFiles()"
    (onFilesUpdate)="onEducationFilesUpdate($event)" />

  <!-- English Qualifications -->
  <app-english-qualifications-view class="block mb-8" [data]="applicationData()?.englishQualifications"
    [englishFiles]="englishFiles()" (onFilesUpdate)="onEnglishFilesUpdate($event)" />

  <!-- Employment History -->
  <app-employment-history-view class="block mb-8" [data]="applicationData()?.employmentHistory" />
  }

  <!-- Edit Mode -->
  @if (!loading() && isEditMode() && editForm) {
  <form [formGroup]="editForm">
    <!-- Personal Details Edit -->
    <app-personal-details-edit class="block mb-8" [formGroup]="personalDetailsForm" [countries]="countries()"
      [provinces]="provinces()" [correspondenceWards]="correspondenceWards()" [permanentWards]="permanentWards()"
      [uploadedFiles]="uploadedFiles()" [onFileChange]="onPassportFileChange.bind(this)"
      [onRemoveFile]="removePassportFile.bind(this)"
      (onCorrespondenceProvinceChange)="onCorrespondenceProvinceChange($event)"
      (onCorrespondenceWardChange)="onCorrespondenceWardChange($event)"
      (onPermanentProvinceChange)="onPermanentProvinceChange($event)"
      (onPermanentWardChange)="onPermanentWardChange($event)" />

    <!-- Application Details Edit -->
    <app-application-details-edit class="block mb-8" [formGroup]="applicationDetailsForm"
      [data]="applicationData()?.applicationDetails" />

    <!-- Education Details Edit -->
    <app-education-details-edit class="block mb-8" [formGroup]="educationDetailsForm" [countries]="countries()"
      [languages]="languages()" [undergraduateFiles]="undergraduateFiles()" [postgraduateFiles]="postgraduateFiles()"
      [onAddUndergraduate]="addUndergraduate.bind(this)" [onRemoveUndergraduate]="removeUndergraduate.bind(this)"
      [onAddPostgraduate]="addPostgraduate.bind(this)" [onRemovePostgraduate]="removePostgraduate.bind(this)"
      [onDegreeFileChange]="onDegreeFileChange.bind(this)" [onRemoveDegreeFile]="removeDegreeFile.bind(this)" />

    <!-- English Qualifications Edit -->
    <app-english-qualifications-edit class="block mb-8" [formGroup]="englishQualificationsForm"
      [englishFiles]="englishFiles()" [onEnglishFileChange]="onEnglishFileChange.bind(this)"
      [onRemoveEnglishFile]="removeEnglishFile.bind(this)" />

    <!-- Employment History Edit -->
    <app-employment-history-edit class="block mb-8" [formGroup]="employmentHistoryForm" />

    <!-- Bottom Action Buttons -->
    <div class="flex justify-end gap-3 pt-6 pr-8 border-t border-gray-200 sticky bottom-0 bg-white py-4 shadow-lg">
      <button type="button" (click)="cancelEdit()"
        class="px-6 py-3 border border-gray-300 rounded-md shadow-sm text-sm font-semibold text-gray-700 bg-white hover:bg-gray-50 transition-colors">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
      <button type="button" (click)="saveChanges()" [disabled]="saving()"
        class="px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-semibold text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 transition-colors">
        {{ saving() ? ('APPLICATION_PAGE.SAVING' | translate) : ('APPLICATION_PAGE.SAVE_CHANGES' | translate) }}
      </button>
    </div>
  </form>
  }
</div>